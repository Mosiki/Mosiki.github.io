

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/sys/favicon.ico">
  <link rel="icon" type="image/png" href="/img/sys/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="WeJan&#39;s Blog的博客">
  <meta name="author" content="WeJan">
  <meta name="keywords" content="">
  <title>MongoDB 极简实践入门 - WeJan&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/androidstudio.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"nullpointer.pw","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"4LBKQGjj91zO3FvvTypea844-MdYXbMMI","app_key":"g000TimpCo2dSkXYBxzm2Tdl","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="WeJan's Blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>WeJan's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/catelog/">
                <i class="iconfont icon-category-fill"></i>
                文章分类目录
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/Mosiki">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-exp-fill"></i>
                Tools
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/others/play.html">
                    
                    Video
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/others/uml.html">
                    
                    UML
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/others/tts.html">
                    
                    TTS
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg/a70.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MongoDB 极简实践入门">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      WeJan
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2018-10-27 09:20" pubdate>
        2018年10月27日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      83
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MongoDB 极简实践入门</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年6月15日 晚上
                
              </p>
            
            <div class="markdown-body">
              <p>以前学习 MongoDB 时候参考的一篇文章，写的蛮好的，很适合 MongoDB 的入门学习，遂转载过来。</p>
<a id="more"></a>

<h1 id="MongoDB-极简实践入门"><a href="#MongoDB-极简实践入门" class="headerlink" title="MongoDB 极简实践入门"></a>MongoDB 极简实践入门</h1><h4 id="1-为什么用MongoDB？"><a href="#1-为什么用MongoDB？" class="headerlink" title="1. 为什么用MongoDB？"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8mongodb"></a>1. 为什么用MongoDB？</h4><p>传统的计算机应用大多使用关系型数据库来存储数据，比如大家可能熟悉的MySql, Sqlite等等，它的特点是数据以表格(table)的形式储存起来的。数据库由一张张排列整齐的表格构成，就好像一个Excel表单一样，每个表格会有若干列，比如一个学生信息表，可能包含学号、姓名、性别、入学年份、高考成绩、籍贯等等。而表格的每一排，则是一个个学生的具体信息。在企业级应用和前互联网时代，关系型数据库几乎是不二选择。关系型数据库的特点是有整齐划一的组织，很方便对数据进行描述、插入、搜索。</p>
<p>想象有一个传统的网上服装商店吧，它的主要的数据可能是储存在一张叫products的表单里，表单可能包含这些列：商品编号(ID)、名称(Name)、商家(brand)、主目录(cate)、子目录(sub-cat)、零售价(price)、是否促销(promotion)等等。如果有一个用户想要查找所有价格低于300元的正在促销的鞋子的编号和名称，则可以执行类似于以下的SQL语句：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> ID, name <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> cate=<span class="hljs-string">&#x27;shoes&#x27;</span> <span class="hljs-keyword">AND</span> price&lt;<span class="hljs-number">300</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">AND</span> promotion=<span class="hljs-literal">true</span>;<br><br></code></pre></div></td></tr></table></figure>
<p>SQL具备了强大了的深度查询能力，能满足各式各样的查询要求。而如果要对数据进行添加和删除，成本也是非常低的。这些是SQL的优势之一， 但随着互联网的兴起以及数据形式的多样化，四平八稳的SQL表单在一些领域渐渐显现出它的劣势。让我们通过一个例子来说明。考虑一个博客后台系统，如果我们用关系型数据库为每篇博客(article)建一个表单的话，这个表单大概会包括以下这些列：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th align="center">Title</th>
<th align="center">Description</th>
<th align="center">Author</th>
<th align="center">Content</th>
<th align="center">Likes</th>
</tr>
</thead>
<tbody><tr>
<td>A_1</td>
<td align="center">Title1</td>
<td align="center">Political Article</td>
<td align="center">Joe</td>
<td align="center">Content 1</td>
<td align="center">12</td>
</tr>
<tr>
<td>A_2</td>
<td align="center">Title2</td>
<td align="center">Humorous Story</td>
<td align="center">Sam</td>
<td align="center">Content 2</td>
<td align="center">50</td>
</tr>
</tbody></table>
<p>这时候用SQL数据库来存储是非常方便的，但假如我们要位每篇文章添加评论功能，会发现每篇文章可能要多篇评论，而且这个数目是动态变化的，而且每篇评论还包括好几项内容：评论的人、评论的时间、以及评论内容。这时候要将这些内容都塞进上述的那个表，就显得很困难。通常的做法是为评论(comment)单独建一个表：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th align="center">Author</th>
<th align="center">Time</th>
<th align="center">Content</th>
<th align="center">Article</th>
</tr>
</thead>
<tbody><tr>
<td>C_1</td>
<td align="center">Anna</td>
<td align="center">2014-12-26 08:23</td>
<td align="center">Really good articles!</td>
<td align="center">A_1</td>
</tr>
<tr>
<td>C_2</td>
<td align="center">David</td>
<td align="center">2014-12-25 09:30</td>
<td align="center">I like it!</td>
<td align="center">A_1</td>
</tr>
</tbody></table>
<p>类似地，每篇文章可能会有若干标签(tags)。标签本身又是一个表单：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th align="center">Category</th>
<th align="center">Tags</th>
<th align="center">Content</th>
<th align="center">Article</th>
</tr>
</thead>
<tbody><tr>
<td>T_1</td>
<td align="center">Anna</td>
<td align="center">2014-12-26 08:23</td>
<td align="center">Really good articles!</td>
<td align="center">A_1</td>
</tr>
<tr>
<td>T_2</td>
<td align="center">David</td>
<td align="center">2014-12-25 09:30</td>
<td align="center">I like it!</td>
<td align="center">A_2</td>
</tr>
</tbody></table>
<p>而博客的表格则要通过foreign key跟这些相关联的表格联系起来(可能还包括作者、出版社等其它表格)。这样一来，当我们做查询的时候，比如说，“找出评论数不少于3的标签为‘政治评论’的作者为Sam的文章”，就会涉及到复杂的跨表查询，需要大量使用<code>join</code>语句。这种跨表查询不仅降低了查询速度，而且这些语句写起来也不简单。</p>
<p>那么，如果用MongoDB数据库来实现，可以如何设计数据模型呢？很简单，像下面这样<a href="http://www.tutorialspoint.com/mongodb/mongodb_data_modeling.htm">[1]</a>：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-attribute">_id</span>: POST_ID<br>  <span class="hljs-attribute">title</span>: TITLE_OF_POST, <br>  <span class="hljs-attribute">description</span>: POST_DESCRIPTION,<br>  <span class="hljs-attribute">author</span>: POST_BY,<br>  <span class="hljs-attribute">tags</span>: [TAG1, TAG2, TAG3],<br>  <span class="hljs-attribute">likes</span>: TOTAL_LIKES, <br>  <span class="hljs-attribute">comments</span>: [	<br>     &#123;<br>        <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;COMMENT_BY&#x27;</span>,<br>        <span class="hljs-attribute">message</span>: TEXT,<br>        <span class="hljs-attribute">dateCreated</span>: DATE_TIME,<br>     &#125;,<br>     &#123;<br>        <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;COMMENT_BY&#x27;</span>,<br>        <span class="hljs-attribute">message</span>: TEXT,<br>        <span class="hljs-attribute">dateCreated</span>: DATE_TIME,<br>     &#125;<br>  ]<br><br></code></pre></div></td></tr></table></figure>
<p>在MongoDB里，每篇博客文章以一个文档(document)的形式保存起来，而文档内部包含了很多项目，比如<code>title tags</code>等，每一个项目都是<code>key-value</code>的形式，即有一个项目的名字，比如<code>title</code>，以及它的值<code>TITLE_OF_POST</code>。而重要的是，一个<code>key</code>可以有多个<code>values</code>，他们用<code>[]</code>括起来。</p>
<p>这种“宽松”的数据存储形式非常灵活，MongoDB不限制每个<code>key</code>对应的<code>values</code>的数目。比如有的文章没有评论，则它的值就是一个空集，完全没有问题；有的文章评论很多，也可以无限制地插入。更灵活的是，MongoDB不要求同一个集合(collection，相当于SQL的table)里面的不同document有相同的key，比如除了上述这种文档组织，有的文档所代表的文章可能没有likes这个项目，再比如有的文章可能有更多的项目，比如可能还有dislikes等等。这些不同的文档都可以灵活地存储在同一个集合下，而且查询起来也异常简单，因为都在一个文档里，不用进行各种跨文档查询。而这种MongoDB式的存储也方便了数据的维护，对于一篇博客文章来说，所有的相关数据都在这个document里面，不用去考虑一个数据操作需要involve多少个表格。</p>
<p>当然，除了上述的优点，MongoDB还有不少别的优势，比如MongoDB的数据是用JSON(Javascript Object Notation)存储的(就是上面的这种key-value的形式)，而几乎所有的web应用都是基于Javascript的。因此，存储的数据和应用的数据的格式是高度一致的，不需经过转换。更多的优点可以查看：<a href="http://www.tutorialspoint.com/mongodb/mongodb_advantages.htm">[2]</a>。</p>
<h4 id="2-关于这篇文章"><a href="#2-关于这篇文章" class="headerlink" title="2. 关于这篇文章"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#2-%E5%85%B3%E4%BA%8E%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0"></a>2. 关于这篇文章</h4><p>这个极简教程，或者说笔记，并不是一个覆盖MongoDB方方面面的教程。所谓极简的意思，就是只选取那些最重要、最常用的内容进行基于实例的介绍，从而让读者能够在最短的时间内快速上手，并且能顺利地进行后续的纵深的学习。</p>
<p>具体地说，这个教程的特点是：</p>
<ul>
<li>  不求全面，只求实用。只覆盖最核心的部分；</li>
<li>  以大量例子为导向；</li>
<li>  一边阅读一边动手操作的话，大约只需要2小时的时间；</li>
</ul>
<p>阅读这篇文章不需要有特别的基础，但最好知道数据库的基本概念，如果本身熟悉SQL那就更好啦。</p>
<h4 id="3-安装与环境"><a href="#3-安装与环境" class="headerlink" title="3. 安装与环境"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#3-%E5%AE%89%E8%A3%85%E4%B8%8E%E7%8E%AF%E5%A2%83"></a>3. 安装与环境</h4><p>MongoDB可以在Windows、Linux、Mac OS X等主流平台运行，而且下载和安装非常简单，非常友好。这篇文档的例子采用MongoDB 2.6版本，均在OS X测试过，有充足的理由相信，在其它平台也能顺利运行。</p>
<p>Windows的安装和设置可以参考：<a href="http://www.w3cschool.cc/mongodb/mongodb-window-install.html%EF%BC%9B">http://www.w3cschool.cc/mongodb/mongodb-window-install.html；</a></p>
<p>Linux的安装和设置可以参考：<a href="http://www.w3cschool.cc/mongodb/mongodb-linux-install.html%EF%BC%9B">http://www.w3cschool.cc/mongodb/mongodb-linux-install.html；</a></p>
<p>Mac OS X下的安装和设置：</p>
<ul>
<li>  1. 在<a href="https://www.mongodb.org/">https://www.mongodb.org/</a> 下载适合你的Mac的MongoDb;</li>
<li>  2. 下载得到的文件是一个zip文件，解压，然后放到你想到的文件夹，比如/Users/Steven/MongoDB;</li>
<li>  3. 创建一个你喜欢的文件夹来存储你的数据，比如/User/Steven/myData;</li>
<li>  4. 打开Terminal，cd到2里面那个文件夹/Users/Steven/MongoDB，再cd bin;</li>
<li>  5. 输入./mongod –dbpath /User/Steven/myData,等到出现类似“waiting for connections on port 27017”，说明MongoDB服务器已架设好，而数据将储存在myData里面；</li>
<li>  6. 新打开一个Terminal, cd /Users/Steven/MongoDB/bin,然后运行./mongo;顺利的话它将出现一个interactive shell让你进行各种操作，而你的数据将储存在myData里</li>
</ul>
<p>如果以上的各个步骤都运行顺利，就可以跳到下一节啦。</p>
<h4 id="4-创建集合和删除集合"><a href="#4-创建集合和删除集合" class="headerlink" title="4. 创建集合和删除集合"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#4-%E5%88%9B%E5%BB%BA%E9%9B%86%E5%90%88%E5%92%8C%E5%88%A0%E9%99%A4%E9%9B%86%E5%90%88"></a>4. 创建集合和删除集合</h4><p>在上一节执行完步骤6后，你会看到命令行里显示：<code>connecting to: test</code>，这里的<code>test</code>是默认的数据库。这里我们可以新建一个数据库。在命令行里打入：</p>
<figure class="highlight stata"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stata"><span class="hljs-keyword">use</span> <span class="hljs-keyword">tutorial</span><br><br></code></pre></div></td></tr></table></figure>
<p>这样就新建了一个叫做<code>tutorial</code>的数据库。你可以执行</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">show</span> databases<br><br></code></pre></div></td></tr></table></figure>
<p>来显示当前的数据库。不过这时候由于我们的新数据库是空的，所以会显示类似这样的：</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">admin</span>  (empty)<br><span class="hljs-attribute">local</span>  <span class="hljs-number">0</span>.<span class="hljs-number">078</span>GB<br><br></code></pre></div></td></tr></table></figure>
<p>我们试着往我们的数据库里添加一个集合(collection)，MongoDB里的集合和SQL里面的表格是类似的：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.createCollection</span>(<span class="hljs-string">&#x27;author&#x27;</span>)<br><br></code></pre></div></td></tr></table></figure>
<p>顺利的话会显示：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;ok&quot;</span> : <span class="hljs-number">1</span> &#125;<br><br></code></pre></div></td></tr></table></figure>
<p>表示创建成功。</p>
<p>你可以再回头执行：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">show</span> databases<br><br></code></pre></div></td></tr></table></figure>
<p>这时候我们的tutorial集合已经位列其中。你可以再执行</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">show</span> collections<br><br></code></pre></div></td></tr></table></figure>
<p>可以看到创建的集合author也在其中。</p>
<p>我们暂时不需要author这个集合，所以我们可以通过执行：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.author</span><span class="hljs-selector-class">.drop</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>来将其删除。这时候你再执行<code>show collections</code>，就再也看不到我们的author了。</p>
<p>这一节要记住的点主要只有一个：集合(collection)类似于SQL的表格(table)，类似于Excel的一个个表格。</p>
<h4 id="5-插入"><a href="#5-插入" class="headerlink" title="5. 插入"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#5-%E6%8F%92%E5%85%A5"></a>5. 插入</h4><p>想象一个精简版的“豆瓣电影”。我们需要创建一个数据库，来存储每部电影的信息，电影的信息包括：</p>
<ul>
<li>  电影名字</li>
<li>  导演</li>
<li>  主演(可能多个)</li>
<li>  类型标签(可能多个)</li>
<li>  上映日期</li>
<li>  喜欢人数</li>
<li>  不喜欢人数</li>
<li>  用户评论(可能多个)</li>
</ul>
<p>显然我们需要先创建一个叫电影的集合：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.createCollection</span>(<span class="hljs-string">&#x27;movie&#x27;</span>)<br><br></code></pre></div></td></tr></table></figure>
<p>然后，我们就可以插入数据了：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.insert</span>(<br> &#123;<br>   <span class="hljs-attribute">title</span>: <span class="hljs-string">&#x27;Forrest Gump&#x27;</span>, <br>   directed_by: <span class="hljs-string">&#x27;Robert Zemeckis&#x27;</span>,<br>   stars: [<span class="hljs-string">&#x27;Tom Hanks&#x27;</span>, <span class="hljs-string">&#x27;Robin Wright&#x27;</span>, <span class="hljs-string">&#x27;Gary Sinise&#x27;</span>],<br>   tags: [<span class="hljs-string">&#x27;drama&#x27;</span>, <span class="hljs-string">&#x27;romance&#x27;</span>],<br>   debut: new <span class="hljs-built_in">Date</span>(<span class="hljs-number">1994</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),<br>   likes: <span class="hljs-number">864367</span>,<br>   dislikes: <span class="hljs-number">30127</span>,<br>   comments: [	<br>      &#123;<br>         user:<span class="hljs-string">&#x27;user1&#x27;</span>,<br>         message: <span class="hljs-string">&#x27;My first comment&#x27;</span>,<br>         dateCreated: new <span class="hljs-built_in">Date</span>(<span class="hljs-number">2013</span>,<span class="hljs-number">11</span>,<span class="hljs-number">10</span>,<span class="hljs-number">2</span>,<span class="hljs-number">35</span>),<br>         like: <span class="hljs-number">0</span> <br>      &#125;,<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user2&#x27;</span>,<br>         message: <span class="hljs-string">&#x27;My first comment too!&#x27;</span>,<br>         dateCreated: new <span class="hljs-built_in">Date</span>(<span class="hljs-number">2013</span>,<span class="hljs-number">11</span>,<span class="hljs-number">11</span>,<span class="hljs-number">6</span>,<span class="hljs-number">20</span>),<br>         like: <span class="hljs-number">0</span> <br>      &#125;<br>   ]<br>&#125;<br>)<br><br></code></pre></div></td></tr></table></figure>
<p>请注意，这里插入数据之前，我们并不需要先声明movie这个集合里面有哪些项目。我们直接插入就可以了~这一点和SQL不一样，SQL必须先声明一个table里面有哪些列，而MongoDB不需要。</p>
<p>把上面的例子复制进命令行应该可以顺利运行，但我强烈建议你手动打一下，或者输入一部你自己喜欢的电影。<code>insert</code>操作有几点需要注意：</p>
<ul>
<li>  1. 不同key-value需要用逗号隔开，而key:value中间是用冒号；</li>
<li>  2. 如果一个key有多个value，value要用[]。哪怕当前只有一个value，也加上[]以备后续的添加；</li>
<li>  3. 整个“数据块”要用{}括起来；</li>
</ul>
<p>如果你在<code>insert</code>之后看到<code>WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</code>，说明写入成功。</p>
<p>这个时候你可以用查询的方式来返回数据库中的数据：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>()<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>这里<code>find()</code>里面是空的，说明我们不做限制和筛选，类似于SQL没有<code>WHERE</code>语句一样。而<code>pretty()</code>输出的是经格式美化后的数据，你可以自己试试没有<code>pretty()</code>会怎么样。</p>
<p>仔细观察<code>find()</code>的结果，你会发现多了一个叫<code>&#39;_id&#39;</code>的东西，这是数据库自动创建的一个ID号，在同一个数据库里，每个文档的ID号都是不同的。</p>
<p>我们也可以同时输入多个数据：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.insert</span>([<br> &#123;<br>   <span class="hljs-attribute">title</span>: <span class="hljs-string">&#x27;Fight Club&#x27;</span>, <br>   <span class="hljs-attribute">directed_by</span>: <span class="hljs-string">&#x27;David Fincher&#x27;</span>,<br>   <span class="hljs-attribute">stars</span>: [<span class="hljs-string">&#x27;Brad Pitt&#x27;</span>, <span class="hljs-string">&#x27;Edward Norton&#x27;</span>, <span class="hljs-string">&#x27;Helena Bonham Carter&#x27;</span>],<br>   <span class="hljs-attribute">tags</span>: <span class="hljs-string">&#x27;drama&#x27;</span>,<br>   <span class="hljs-attribute">debut</span>: new Date(<span class="hljs-number">1999</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),<br>   <span class="hljs-attribute">likes</span>: <span class="hljs-number">224360</span>,<br>   <span class="hljs-attribute">dislikes</span>: <span class="hljs-number">40127</span>,<br>   <span class="hljs-attribute">comments</span>: [	<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user3&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;My first comment&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2008</span>,<span class="hljs-number">09</span>,<span class="hljs-number">13</span>,<span class="hljs-number">2</span>,<span class="hljs-number">35</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">0</span> <br>      &#125;,<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user2&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;My first comment too!&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2003</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">6</span>,<span class="hljs-number">20</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">14</span> <br>      &#125;,<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user7&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;Good Movie!&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2009</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">6</span>,<span class="hljs-number">20</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">2</span><br>      &#125;<br>   ]<br>&#125;,<br>&#123;<br>   <span class="hljs-attribute">title</span>: <span class="hljs-string">&#x27;Seven&#x27;</span>, <br>   <span class="hljs-attribute">directed_by</span>: <span class="hljs-string">&#x27;David Fincher&#x27;</span>,<br>   <span class="hljs-attribute">stars</span>: [<span class="hljs-string">&#x27;Morgan Freeman&#x27;</span>, <span class="hljs-string">&#x27;Brad Pitt&#x27;</span>,  <span class="hljs-string">&#x27;Kevin Spacey&#x27;</span>],<br>   <span class="hljs-attribute">tags</span>: [<span class="hljs-string">&#x27;drama&#x27;</span>,<span class="hljs-string">&#x27;mystery&#x27;</span>,<span class="hljs-string">&#x27;thiller&#x27;</span>],<br>   <span class="hljs-attribute">debut</span>: new Date(<span class="hljs-number">1995</span>,<span class="hljs-number">9</span>,<span class="hljs-number">22</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),<br>   <span class="hljs-attribute">likes</span>: <span class="hljs-number">134370</span>,<br>   <span class="hljs-attribute">dislikes</span>: <span class="hljs-number">1037</span>,<br>   <span class="hljs-attribute">comments</span>: [	<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user3&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;Love Kevin Spacey&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2002</span>,<span class="hljs-number">09</span>,<span class="hljs-number">13</span>,<span class="hljs-number">2</span>,<span class="hljs-number">35</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">0</span> <br>      &#125;,<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user2&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;Good works!&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2013</span>,<span class="hljs-number">10</span>,<span class="hljs-number">21</span>,<span class="hljs-number">6</span>,<span class="hljs-number">20</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">14</span> <br>      &#125;,<br>      &#123;<br>         <span class="hljs-attribute">user</span>:<span class="hljs-string">&#x27;user7&#x27;</span>,<br>         <span class="hljs-attribute">message</span>: <span class="hljs-string">&#x27;Good Movie!&#x27;</span>,<br>         <span class="hljs-attribute">dateCreated</span>: new Date(<span class="hljs-number">2009</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">6</span>,<span class="hljs-number">20</span>),<br>         <span class="hljs-attribute">like</span>: <span class="hljs-number">2</span><br>      &#125;<br>   ]<br>&#125;<br>])<br><br></code></pre></div></td></tr></table></figure>
<p>顺利的话会显示：</p>
<figure class="highlight ada"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ada">BulkWriteResult(&#123;<br>	<span class="hljs-string">&quot;writeErrors&quot;</span> : [ ],<br>	<span class="hljs-string">&quot;writeConcernErrors&quot;</span> : [ ],<br>	<span class="hljs-string">&quot;nInserted&quot;</span> : 2,<br>	<span class="hljs-string">&quot;nUpserted&quot;</span> : 0,<br>	<span class="hljs-string">&quot;nMatched&quot;</span> : 0,<br>	<span class="hljs-string">&quot;nModified&quot;</span> : 0,<br>	<span class="hljs-string">&quot;nRemoved&quot;</span> : 0,<br>	<span class="hljs-string">&quot;upserted&quot;</span> : [ ]<br><br></code></pre></div></td></tr></table></figure>
<p>表面我们成功地插入了两个数据。注意批量插入的格式是这样的：<code>db.movie.insert([&#123;ITEM1&#125;,&#123;ITEM2&#125;])</code>。几部电影的外面需要用[]括起来。</p>
<p>请注意，虽然collection的插入不需要先声明，但表达相同意思的key，名字要一样，比如，如果我们在一个文档里用<code>directed_by</code>来表示导演，则在其它文档也要保持同样的名字(而不是<code>director</code>之类的)。不同的名字不是不可以，技术上完全可行，但会给查询和更新带来困难。</p>
<p>好了，到这里，我们就有了一个叫tutorial的数据库，里面有一个叫movie的集合，而movie里面有三个记录。接下来我们就可以对其进行查询了。</p>
<h4 id="6-查询"><a href="#6-查询" class="headerlink" title="6. 查询"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#6-%E6%9F%A5%E8%AF%A2"></a>6. 查询</h4><p>在上一节我们已经接触到最简单的查询<code>db.movie.find().pretty()</code>。MongoDB支持各种各样的深度查询功能。先来一个最简单的例子，找出大卫芬奇(David Fincher)导演的所有电影：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;directed_by&#x27;</span>:<span class="hljs-string">&#x27;David Fincher&#x27;</span>&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>将返回《搏击俱乐部》和《七宗罪》两部电影。这种搜索和SQL的<code>WHERE</code>语句是很相似的。</p>
<p>也可以设置多个条件。比如找出大卫芬奇导演的, 摩根弗里曼主演的电影：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;directed_by&#x27;</span>:<span class="hljs-string">&#x27;David Fincher&#x27;</span>, <span class="hljs-string">&#x27;stars&#x27;</span>:<span class="hljs-string">&#x27;Morgan Freeman&#x27;</span>&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>这里两个条件之间，是AND的关系，只有同时满足两个条件的电影才会被输出。同理，可以设置多个的条件，不赘述。</p>
<p>条件之间也可以是或的关系，比如找出罗宾怀特或摩根弗里曼主演的电影：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(<br>&#123;<br>  <span class="hljs-variable">$or</span>: <br>     [  &#123;<span class="hljs-string">&#x27;stars&#x27;</span>:<span class="hljs-string">&#x27;Robin Wright&#x27;</span>&#125;, <br>        &#123;<span class="hljs-string">&#x27;stars&#x27;</span>:<span class="hljs-string">&#x27;Morgan Freeman&#x27;</span>&#125;<br>     ]<br>&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>注意这里面稍显复杂的各种括号。</p>
<p>还可以设置一个范围的搜索，比如找出50万人以上赞的电影：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;likes&#x27;</span>:&#123;<span class="hljs-variable">$gt</span>:500000&#125;&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>同样要注意略复杂的括号。注意，在这些查询里，key的单引号都是可选的，也就是说，上述语句也可以写成：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">likes</span>:&#123;$gt:<span class="hljs-number">500000</span>&#125;&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>类似地，少于二十万人赞的电影：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">likes</span>:&#123;$lt:<span class="hljs-number">200000</span>&#125;&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>类似的运算符还有：<code>$lte</code>:小于或等于；<code>$gte</code>:大于或等于；<code>$ne</code>:不等于。</p>
<p>注意，对于包含多个值的key，同样可以用find来查询。比如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;romance&#x27;</span>&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>将返回《阿甘正传》，虽然其标签既有romance，又有drama，但只要符合一个就可以了。</p>
<p>如果你确切地知道返回的结果只有一个，也可以用<code>findOne</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.movie</span>.findOne(&#123;<span class="hljs-string">&#x27;title&#x27;</span>:<span class="hljs-string">&#x27;Forrest Gump&#x27;</span>&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>如果有多个结果，则会按磁盘存储顺序返回第一个。请注意，<code>findOne()</code>自带pretty模式，所以不能再加<code>pretty()</code>，将报错。</p>
<p>如果结果很多而你只想显示其中一部分，可以用<code>limit()</code>和<code>skip()</code>，前者指明输出的个数，后者指明从第二个结果开始数。比如：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>()<span class="hljs-selector-class">.limit</span>(2)<span class="hljs-selector-class">.skip</span>(1)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>则跳过第一部，从第二部开始选取两部电影。</p>
<h4 id="7-局部查询"><a href="#7-局部查询" class="headerlink" title="7. 局部查询"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#7-%E5%B1%80%E9%83%A8%E6%9F%A5%E8%AF%A2"></a>7. 局部查询</h4><p>第五节的时候我们讲了<code>find</code>的用法，但对于符合条件的条目，我们都是返回整个JSON文件的。这类似于SQL里面的<code>SELECT *</code>。有的时候，我们需要的，仅仅是部分数据，这个时候，<code>find</code>的局部查询的功能就派上用场了。先来看一个例子，返回tags为drama的电影的名字和首映日期。</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;drama&#x27;</span>&#125;,&#123;<span class="hljs-string">&#x27;debut&#x27;</span>:1,<span class="hljs-string">&#x27;title&#x27;</span>:1&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>数据库将返回：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>	<span class="hljs-attr">&quot;_id&quot;</span> : ObjectId(<span class="hljs-string">&quot;549cfb42f685c085f1dd47d4&quot;</span>),<br>	<span class="hljs-attr">&quot;title&quot;</span> : <span class="hljs-string">&quot;Forrest Gump&quot;</span>,<br>	<span class="hljs-attr">&quot;debut&quot;</span> : ISODate(<span class="hljs-string">&quot;1994-08-05T16:00:00Z&quot;</span>)<br>&#125;<br>&#123;<br>	<span class="hljs-attr">&quot;_id&quot;</span> : ObjectId(<span class="hljs-string">&quot;549cff96f685c085f1dd47d6&quot;</span>),<br>	<span class="hljs-attr">&quot;title&quot;</span> : <span class="hljs-string">&quot;Fight Club&quot;</span>,<br>	<span class="hljs-attr">&quot;debut&quot;</span> : ISODate(<span class="hljs-string">&quot;1999-11-14T16:00:00Z&quot;</span>)<br>&#125;<br>&#123;<br>	<span class="hljs-attr">&quot;_id&quot;</span> : ObjectId(<span class="hljs-string">&quot;549cff96f685c085f1dd47d7&quot;</span>),<br>	<span class="hljs-attr">&quot;title&quot;</span> : <span class="hljs-string">&quot;Seven&quot;</span>,<br>	<span class="hljs-attr">&quot;debut&quot;</span> : ISODate(<span class="hljs-string">&quot;1995-10-21T16:00:00Z&quot;</span>)<br>&#125;<br><br></code></pre></div></td></tr></table></figure>
<p>这里find的第二个参数是用来控制输出的，1表示要返回，而0则表示不返回。默认值是0，但<code>_id</code>是例外，因此如果你不想输出<code>_id</code>，需要显式地声明：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;drama&#x27;</span>&#125;,&#123;<span class="hljs-string">&#x27;debut&#x27;</span>:1,<span class="hljs-string">&#x27;title&#x27;</span>:1,<span class="hljs-string">&#x27;_id&#x27;</span>:0&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<h4 id="8-更新"><a href="#8-更新" class="headerlink" title="8. 更新"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#8-%E6%9B%B4%E6%96%B0"></a>8. 更新</h4><p>很多情况下你需要更新你的数据库，比如有人对某部电影点了个赞，那么你需要更新相应的数据库。比如有人对《七宗罪》点了个赞，而它本来的赞的个数是134370，那么你需要更新到134371。可以这样操作：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;Seven&#x27;</span>&#125;, &#123;$<span class="hljs-attribute">set</span>:&#123;<span class="hljs-attribute">likes</span>:<span class="hljs-number">134371</span>&#125;&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>第一个大括号里表明要选取的对象，第二个表明要改动的数据。请注意上述的操作相当不现实，因为你首先要知道之前的数字是多少，然后加一，但通常你不读取数据库的话，是不会知道这个数(134370)的。MongoDB提供了一种简便的方法，可以对现有条目进行增量操作。假设又有人对《七宗罪》点了两个赞，则可以：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;Seven&#x27;</span>&#125;, &#123;$<span class="hljs-attribute">inc</span>:&#123;<span class="hljs-attribute">likes</span>:<span class="hljs-number">2</span>&#125;&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>如果你查询的话，会发现点赞数变为134373了，这里用的是<code>$inc</code>。除了增量更新，MongoDB还提供了很多灵活的更新选项，具体可以看：<a href="http://docs.mongodb.org/manual/reference/operator/update-field/">http://docs.mongodb.org/manual/reference/operator/update-field/</a> 。</p>
<p>注意如果有多部符合要求的电影。则默认只会更新第一个。如果要多个同时更新，要设置<code>&#123;multi:true&#125;</code>，像下面这样：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;&#125;, &#123;$<span class="hljs-attribute">inc</span>:&#123;<span class="hljs-attribute">likes</span>:<span class="hljs-number">10</span>&#125;&#125;,&#123;<span class="hljs-attribute">multi</span>:true&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>所有电影的赞数都多了10.</p>
<p>注意，以上的更新操作会替换掉原来的值，所以如果你是想在原有的值得基础上增加一个值的话，则应该用<code>$push</code>，比如，为《七宗罪》添加一个popular的tags。</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">db<span class="hljs-selector-class">.movie</span>.update(&#123;<span class="hljs-string">&#x27;title&#x27;</span>:<span class="hljs-string">&#x27;Seven&#x27;</span>&#125;, &#123;<span class="hljs-variable">$push</span>:&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;popular&#x27;</span>&#125;&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>你会发现《七宗罪》现在有四个标签：</p>
<figure class="highlight ada"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ada"><span class="hljs-string">&quot;tags&quot;</span> : [<br>	<span class="hljs-string">&quot;drama&quot;</span>,<br>	<span class="hljs-string">&quot;mystery&quot;</span>,<br>	<span class="hljs-string">&quot;thiller&quot;</span>,<br>	<span class="hljs-string">&quot;popular&quot;</span><br>],<br><br></code></pre></div></td></tr></table></figure>
<h4 id="9-删除"><a href="#9-删除" class="headerlink" title="9. 删除"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#9-%E5%88%A0%E9%99%A4"></a>9. 删除</h4><p>删除的句法和find很相似，比如，要删除标签为romance的电影，则：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">remove</span>(&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;romance&#x27;</span>&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>考虑到我们数据库条目异常稀少，就不建议你执行这条命令了~</p>
<p>注意，上面的例子会删除所有标签包含romance的电影。如果你只想删除第一个，则</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">remove</span>(&#123;<span class="hljs-string">&#x27;tags&#x27;</span>:<span class="hljs-string">&#x27;romance&#x27;</span>&#125;,1)<br><br></code></pre></div></td></tr></table></figure>
<p>如果不加任何限制：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.remove</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>会删除movie这个集合下的所有文档。</p>
<h4 id="10-索引和排序"><a href="#10-索引和排序" class="headerlink" title="10. 索引和排序"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#10-%E7%B4%A2%E5%BC%95%E5%92%8C%E6%8E%92%E5%BA%8F"></a>10. 索引和排序</h4><p>为文档中的一些key加上索引(index)可以加快搜索速度。这一点不难理解，假如没有没有索引，我们要查找名字为Seven的电影，就必须在所有文档里逐个搜索。而如果对名字这个key加上索引值，则电影名这个字符串和数字建立了映射，这样在搜索的时候就会快很多。排序的时候也是如此，不赘述。MongoDB里面为某个key加上索引的方式很简单，比如我们要对导演这个key加索引，则可以：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.ensureIndex</span>(&#123;<span class="hljs-attribute">directed_by</span>:<span class="hljs-number">1</span>&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>这里的1是升序索引，如果要降序索引，用-1。</p>
<p>MongoDB支持对输出进行排序，比如按名字排序：</p>
<figure class="highlight dos"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dos">db.movie.<span class="hljs-built_in">find</span>().<span class="hljs-built_in">sort</span>(&#123;&#x27;<span class="hljs-built_in">title</span>&#x27;:<span class="hljs-number">1</span>&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>同样地，1是升序，-1是降序。默认是1。</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.getIndexes</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>将返回所有索引，包括其名字。</p>
<p>而</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.dropIndex</span>(<span class="hljs-string">&#x27;index_name&#x27;</span>)<br><br></code></pre></div></td></tr></table></figure>
<p>将删除对应的索引。</p>
<h4 id="11-聚合"><a href="#11-聚合" class="headerlink" title="11. 聚合"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#11-%E8%81%9A%E5%90%88"></a>11. 聚合</h4><p>MongoDB支持类似于SQL里面的<code>GROUP BY</code>操作。比如当有一张学生成绩的明细表时，我们可以找出每个分数段的学生各有多少。为了实现这个操作，我们需要稍加改动我们的数据库。执行以下三条命令：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;Seven&#x27;</span>&#125;,&#123;$<span class="hljs-attribute">set</span>:&#123;<span class="hljs-attribute">grade</span>:<span class="hljs-number">1</span>&#125;&#125;)<br><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;Forrest Gump&#x27;</span>&#125;,&#123;$<span class="hljs-attribute">set</span>:&#123;<span class="hljs-attribute">grade</span>:<span class="hljs-number">1</span>&#125;&#125;)<br><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.update</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;Fight Club&#x27;</span>&#125;,&#123;$<span class="hljs-attribute">set</span>:&#123;<span class="hljs-attribute">grade</span>:<span class="hljs-number">2</span>&#125;&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>这几条是给每部电影加一个虚拟的分级，前两部是归类是一级，后一部是二级。</p>
<p>这里你也可以看到MongoDB的强大之处：可以动态地后续添加各种新项目。</p>
<p>我们先通过聚合来找出总共有几种级别。</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.aggregate</span>([&#123;$<span class="hljs-attribute">group</span>:&#123;<span class="hljs-attribute">_id</span>:<span class="hljs-string">&#x27;$grade&#x27;</span>&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-number">2</span> &#125;<br>&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-number">1</span> &#125;<br><br></code></pre></div></td></tr></table></figure>
<p>注意这里的2和1是指级别，而不是每个级别的电影数。这个例子看得清楚些：</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.aggregate</span>([&#123;$<span class="hljs-attribute">group</span>:&#123;<span class="hljs-attribute">_id</span>:<span class="hljs-string">&#x27;$directed_by&#x27;</span>&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>这里按照导演名字进行聚合。输出：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;David Fincher&quot;</span> &#125;<br>&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Robert Zemeckis&quot;</span> &#125;<br><br></code></pre></div></td></tr></table></figure>
<p>接着我们要找出，每个导演的电影数分别有多少：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">db.movie.aggregate([&#123;<span class="hljs-attr">$group:</span>&#123;<span class="hljs-attr">_id:</span><span class="hljs-string">&#x27;$directed_by&#x27;</span>,<span class="hljs-attr">num_movie:</span>&#123;<span class="hljs-attr">$sum:</span><span class="hljs-number">1</span>&#125;&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;David Fincher&quot;</span>, <span class="hljs-attr">&quot;num_movie&quot;</span> : <span class="hljs-number">2</span> &#125;<br>&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Robert Zemeckis&quot;</span>, <span class="hljs-attr">&quot;num_movie&quot;</span> : <span class="hljs-number">1</span> &#125;<br><br></code></pre></div></td></tr></table></figure>
<p>注意$sum后面的1表示只是把电影数加起来，但我们也可以统计别的数据，比如两位导演谁的赞比较多：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">db.movie.aggregate([&#123;<span class="hljs-attr">$group:</span>&#123;<span class="hljs-attr">_id:</span><span class="hljs-string">&#x27;$directed_by&#x27;</span>,<span class="hljs-attr">num_likes:</span>&#123;<span class="hljs-attr">$sum:</span><span class="hljs-string">&#x27;$likes&#x27;</span>&#125;&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;David Fincher&quot;</span>, <span class="hljs-attr">&quot;num_likes&quot;</span> : <span class="hljs-number">358753</span> &#125;<br>&#123; <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;Robert Zemeckis&quot;</span>, <span class="hljs-attr">&quot;num_likes&quot;</span> : <span class="hljs-number">864377</span> &#125;<br><br></code></pre></div></td></tr></table></figure>
<p>注意这些数据都纯属虚构啊！</p>
<p>除了<code>$sum</code>，还有其它一些操作。比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">db.movie.aggregate([&#123;<span class="hljs-attr">$group:</span>&#123;<span class="hljs-attr">_id:</span><span class="hljs-string">&#x27;$directed_by&#x27;</span>,<span class="hljs-attr">num_movie:</span>&#123;<span class="hljs-attr">$avg:</span><span class="hljs-string">&#x27;$likes&#x27;</span>&#125;&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>统计平均的赞。</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">db.movie.aggregate([&#123;<span class="hljs-attr">$group:</span>&#123;<span class="hljs-attr">_id:</span><span class="hljs-string">&#x27;$directed_by&#x27;</span>,<span class="hljs-attr">num_movie:</span>&#123;<span class="hljs-attr">$first:</span><span class="hljs-string">&#x27;$likes&#x27;</span>&#125;&#125;&#125;])<br><br></code></pre></div></td></tr></table></figure>
<p>返回每个导演的电影中的第一部的赞数。</p>
<p>其它各种操作可以参考：<a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/">http://docs.mongodb.org/manual/reference/operator/aggregation/group/</a> 。</p>
<h4 id="12-All-or-Nothing"><a href="#12-All-or-Nothing" class="headerlink" title="12. All or Nothing?"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#12-all-or-nothing"></a>12. All or Nothing?</h4><p>MongoDB支持单个文档内的原子化操作(atomic operation)，这是说，可以将多条关于同一个文档的指令放到一起，他们要么一起执行，要么都不执行。而不会执行到一半。有些场合需要确保多条执行一起顺次执行。比如一个场景：一个电商网站，用户查询某种商品的剩余数量，以及用户购买该种商品，这两个操作，必须放在一起执行。不然的话，假定我们先执行剩余数量的查询，这是假定为1，用户接着购买，但假如这两个操作之间还加入了其它操作，比如另一个用户抢先购买了，那么原先购买用户的购买的行为就会造成数据库的错误，因为实际上这种商品以及没有存货了。但因为查询剩余数量和购买不是在一个“原子化操作”之内，因此会发生这样的错误<a href="http://www.tutorialspoint.com/mongodb/mongodb_atomic_operations.htm">[2]</a>。</p>
<p>MongoDB提供了<code>findAndModify</code>的方法来确保atomic operation。比如这样的：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">db.movie.findAndModify(<br>			&#123;<br>			<span class="hljs-symbol">query:</span>&#123;<span class="hljs-string">&#x27;title&#x27;</span>:<span class="hljs-string">&#x27;Forrest Gump&#x27;</span>&#125;,<br>			<span class="hljs-symbol">update:</span>&#123;<span class="hljs-attr">$inc:</span>&#123;<span class="hljs-attr">likes:</span><span class="hljs-number">10</span>&#125;&#125;<br>			&#125;<br>		      )<br><br></code></pre></div></td></tr></table></figure>
<p>query是查找出匹配的文档，和find是一样的，而update则是更新likes这个项目。注意由于MongoDB只支持单个文档的atomic operation，因此如果query出多于一个文档，则只会对第一个文档进行操作。</p>
<p><code>findAndModify</code>还支持更多的操作，具体见：<a href="http://docs.mongodb.org/manual/reference/command/findAndModify/%E3%80%82">http://docs.mongodb.org/manual/reference/command/findAndModify/。</a></p>
<h4 id="13-文本搜索"><a href="#13-文本搜索" class="headerlink" title="13. 文本搜索"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#13-%E6%96%87%E6%9C%AC%E6%90%9C%E7%B4%A2"></a>13. 文本搜索</h4><p>除了前面介绍的各种深度查询功能，MongoDB还支持文本搜索。对文本搜索之前，我们需要先对要搜索的key建立一个text索引。假定我们要对标题进行文本搜索，我们可以先这样：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.ensureIndex</span>(&#123;<span class="hljs-attribute">title</span>:<span class="hljs-string">&#x27;text&#x27;</span>&#125;)<br><br></code></pre></div></td></tr></table></figure>
<p>接着我们就可以对标题进行文本搜索了，比如，查找带有”Gump”的标题：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">db.movie.<span class="hljs-builtin-name">find</span>(&#123;<span class="hljs-variable">$text</span>:&#123;<span class="hljs-variable">$search</span>:<span class="hljs-string">&quot;Gump&quot;</span>&#125;&#125;).pretty()<br><br></code></pre></div></td></tr></table></figure>
<p>注意text和search前面的$符号。</p>
<p>这个例子里，文本搜索作用不是非常明显。但假设我们要搜索的key是一个长长的文档，这种text search的方便性就显现出来了。MongoDB目前支持15种语言的文本搜索。</p>
<h4 id="14-正则表达式"><a href="#14-正则表达式" class="headerlink" title="14. 正则表达式"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#14-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"></a>14. 正则表达式</h4><p>MongoDB还支持基于正则表达式的查询。如果不知道正则表达式是什么，可以参考<a href="http://en.wikipedia.org/wiki/Regular_expression">Wikipedia</a>。这里简单举几个例子。比如，查找标题以<code>b</code>结尾的电影信息：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">title</span>:&#123;$regex:<span class="hljs-string">&#x27;.*b$&#x27;</span>&#125;&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>也可以写成：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">title</span>:/.*b$/&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>查找含有’Fight’标题的电影：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">title</span>:/Fight/&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p>注意以上匹配都是区分大小写的，如果你要让其不区分大小写，则可以：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.movie</span><span class="hljs-selector-class">.find</span>(&#123;<span class="hljs-attribute">title</span>:&#123;$regex:<span class="hljs-string">&#x27;fight.*b&#x27;</span>,$options:<span class="hljs-string">&#x27;$i&#x27;</span>&#125;&#125;)<span class="hljs-selector-class">.pretty</span>()<br><br></code></pre></div></td></tr></table></figure>
<p><code>$i</code>是insensitive的意思。这样的话，即使是小写的fight，也能搜到了。</p>
<h4 id="15-后记"><a href="#15-后记" class="headerlink" title="15. 后记"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#15-%E5%90%8E%E8%AE%B0"></a>15. 后记</h4><p>至此，MongoDB的最基本的内容就介绍得差不多了。如果有什么遗漏的以后我会补上來。如果你一路看到底完全了这个入门教程，恭喜你，你一定是一个有毅力的人。</p>
<p>把这个文档过一遍，不会让你变成一个MongoDB的专家(如果会那就太奇怪了)。但如果它能或多或少减少你上手的时间，或者让你意识到“咦，MongoDB其实没那么复杂”，那么这个教程的目的也就达到啦。</p>
<p>这个文档是匆忙写就的，出错简直是一定的。如果您发现了任何错误或者有关于本文的任何建议，麻烦发邮件给我（stevenslxie at gmail.com）或者在GitHub上直接交流，不胜感激。</p>
<h4 id="转载声明"><a href="#转载声明" class="headerlink" title="转载声明"></a><a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md#%E8%BD%AC%E8%BD%BD%E5%A3%B0%E6%98%8E"></a>转载声明</h4><p>如果你喜欢这篇文章，可以随意转载。但请</p>
<ul>
<li>  标明原作者StevenSLXie;</li>
<li>  标明原链接(<a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md">https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md</a>);</li>
<li>  在可能的情况下请保持文本显示的美观。比如，请不要直接一键复制到博客之类，因为代码的显示效果可能非常糟糕;</li>
<li>  请将这个转载声明包含进来；</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/mongodb/">mongodb</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/IDEA%E4%B9%8BGit%E5%88%86%E6%94%AF%E5%90%88%E5%B9%B6%E4%BB%A5%E5%8F%8AStash%E4%BD%BF%E7%94%A8.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">IDEA之Git分支以及Stash使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Java%E7%94%9F%E6%88%90sitemap%E7%BD%91%E7%AB%99%E5%9C%B0%E5%9B%BE.html">
                        <span class="hidden-mobile">Java生成sitemap网站地图</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "4LBKQGjj91zO3FvvTypea844-MdYXbMMI",
          app_key: "g000TimpCo2dSkXYBxzm2Tdl",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: true,
          serverURLs: "https://blog.nullpointer.pw",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="https://valine.js.org" rel="nofollow noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
